dependencies {
	compile 'org.eclipse.xtext:org.eclipse.xtext.xtext:2.6.0'
	compile 'org.eclipse.xtext:org.eclipse.xtext.xbase:2.6.0'
	compile 'org.eclipse.xtext:org.eclipse.xtext:2.6.0'
	compile 'org.eclipse.xtext:org.eclipse.xtext.builder.standalone:2.6.0'
	
	compile 'org.eclipse.xtend:org.eclipse.xtend.lib:2.6.0'
	compile 'org.eclipse.xtext:org.eclipse.xtext.xbase.lib:2.6.0'
	
	compile project(':mango-db')
}

buildscript {
    repositories {
	    mavenCentral()
	    maven {
	            url "http://build.eclipse.org/common/xtend/maven/"
	    }
    }

    dependencies {
        classpath 'org.eclipse.xtend:org.eclipse.xtend.standalone:2.4.3'
    }
}

def srcTempDir = file('build/src-temp')
def xtendSrcDir = srcTempDir //file('src')
def xtendGenTargetDir = file('xtend-gen')

sourceSets {
    main {
        java {
            srcDirs = [ 'src', 'xtend-gen', 'src-gen' ] 

        }
        resources {
            srcDirs = [ 'src', 'xtend-gen', 'src-gen' ] 
        }
    }
	
    generatedXtext {
        java {
            srcDirs = [ 'src-gen' ]
        }
        resources {
            srcDirs = [ 'src-gen' ]
        }
		
		compileClasspath += project.sourceSets.main.compileClasspath
    }
	
	generatedXtend {
		java {
			srcDirs = [ 'xtend-gen' ]
		}
		resources {
			srcDirs = [ 'xtend-gen' ]
		}
		
		compileClasspath += project.sourceSets.main.compileClasspath
	}

}

task copyTempSources(type: Copy) {
	
	xtendGenTargetDir.delete()
	xtendGenTargetDir.mkdirs()
	
	srcTempDir.delete()
	srcTempDir.mkdirs()
	
	into srcTempDir
	
	from sourceSets.generatedXtext.allSource
	from sourceSets.main.allSource
}

eclipse {
    project {
	    natures 'org.eclipse.xtext.ui.shared.xtextNature'
	    buildCommand 'org.eclipse.xtext.ui.shared.xtextBuilder'
    }
}

task generateXtext(type: JavaExec) {
    main = "org.eclipse.emf.mwe2.launch.runtime.Mwe2Launcher"

    classpath = configurations.compile
    classpath += files('src')

    args = [ "classpath:///io/pelle/mango/dsl/GenerateMango.mwe2" ]
}

import org.apache.log4j.BasicConfigurator
import org.eclipse.xtend.core.XtendStandaloneSetup
import org.eclipse.xtend.core.compiler.batch.XtendBatchCompiler

task generateXtend {

    inputs.dir xtendSrcDir
    outputs.dir xtendGenTargetDir

    doLast {
		
        def srcPath = xtendSrcDir.absolutePath
        def targetPath = xtendGenTargetDir.absolutePath
        def classpath = configurations.compile.asPath

        BasicConfigurator.configure()
		
        XtendBatchCompiler compiler = new 
		XtendStandaloneSetup().createInjectorAndDoEMFRegistration().getInstance(XtendBatchCompiler.class)
        compiler.setOutputPath(targetPath)
        compiler.setClassPath(classpath)
        compiler.setSourcePath(srcPath)

        if (!compiler.compile()) {
                throw new GradleException("Xtend compilation failed.");
        }
    }
}

copyTempSources.dependsOn generateXtext
generateXtend.dependsOn copyTempSources
compileJava.dependsOn generateXtend

libDir = new File('lib')

task copyRuntimeLibs(type: Copy) {
    libDir.mkdirs()
    into libDir
    from configurations.runtime
}

build.dependsOn(copyRuntimeLibs)
